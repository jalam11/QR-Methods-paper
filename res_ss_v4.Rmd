---
title: "res_ss_v4"
author: "Josh Alampi"
date: "2023-04-11"
output: html_document
---

#load
```{r}
#clear workspace
rm(list=ls(all=TRUE))

#load packages
library(readr); library(writexl) # for read_csv(); write_xlsx()
library(plyr) # mapvalues()
library(MASS)
library(dplyr)
library(tidyr) # for gather()
library(ggplot2)
library(ggrepel); library(ggpubr); library(scales) # extra ggplot features
library(signs) # for signs_format(), uses proper minus sign instead of hyphen
library(lmtest) # for bptest()
library(quantreg)
library(bayesQR)
select <- dplyr::select
library(rstan)
library(tidyverse)
source("functions/ggplot functions.R")
```

```{r}
data_dith <- read.csv("sim study/raw results/table_ss_JA model_2021-08-07_1000_sims.csv")
data_cnts <- read.csv("sim study/raw results/table_ss_JA moel_gold_2021-10-28_1000_sims.csv")

nrow(data_dith)
nrow(data_cnts)
```

# clean

##  Count data
```{r}
data_dith <- data_dith %>% 
  filter(method != "bayes_adj_v1") # do not need adj_v1 (the default SW adjustment), as I have demonstrated earlier that it is defective. 

data_dith$method <- data_dith$method %>% # shorten the Bayesian methods' names
  mapvalues("bayes_adj_v2", "bnid") %>% 
  mapvalues("bayes", "biid") 

data_dith <- data_dith %>% # new variable: status tells us the type of data
  mutate(status = ifelse(method %in% c("bnid", "biid"),
                         "Bayesian", # Bayesian methods were not dithered
                         "Freq. (count)")) # Frequentist methods were dithered

```

## Continuous data (Bayesian methods not used)
```{r}
data_cnts <- data_cnts %>% 
  filter(is.na(method) == F) %>% # gets rid of blank method rows
  mutate(status = "Freq. (cnts)")

```

## combine
```{r}
data <- rbind(data_dith, data_cnts); nrow(data)
rm(data_dith, data_cnts)
```


# prep for analysis
## basic cleanup
```{r}
data$model <- data$model %>% # give the models proper names
  mapvalues(1, "Model 1") %>% 
  mapvalues(2, "Model 2") %>% 
  mapvalues(3, "Model 3") %>% 
  mapvalues(4, "Model 4") 

data$beta <- as.numeric(data$beta)
data$lb <- as.numeric(data$lb)
data$ub <- as.numeric(data$ub)
data$tau <- as.factor(data$tau)
```

## find interval width, remove infinite intervals
```{r}
# find interval width, with infinite intervals set to NA
data <- data %>% 
  mutate(int_width = ub - lb)

# Flag and delete infinite intervals
# Flag and delete simulations with no effect estimate
data <- data %>% 
  mutate(infin_flag = ifelse(is.infinite(lb) == T | is.infinite(ub) == T
                             # | lb > abs(10000) | ub > abs(10000)
                             ,
                             T, # interval is infinite or so large it should be removed
                             F) ) %>%
  mutate(na_flag = ifelse(is.na(beta) == T,
                          T, # no effect estimate is given due to failure to converge
                          F)) %>% 
  mutate(lb = ifelse(infin_flag == T | na_flag == T, NA, lb)) %>%
  mutate(ub = ifelse(infin_flag == T | na_flag == T, NA, ub)) %>%
  mutate(int_width = ifelse(infin_flag == T | na_flag == T, NA, int_width))

```

## find average beta and average CI width across each group of variable
```{r}
# Find the mean \hat(beta_i) across repetitions 
# Morris et al 2017 calls this value "beta-vinculum", the beta symboll with a flat line on top
data_summarised_1 <- data %>% 
  group_by(method, tau, model, n, status) %>% 
  summarise(mean_beta = mean(beta, na.rm = T)) 

# Repeat this process with mean(\hat(interval width))
data_summarised_2 <- data %>% 
  group_by(method, tau, model, n, status) %>% 
  summarise(mean_intwidth = mean(int_width, na.rm = T))


# Add this value to the dataframe
data <- merge(data, data_summarised_1, by=c("method", "tau", "model", "n", "status"))
data <- merge(data, data_summarised_2, by=c("method", "tau", "model", "n", "status"))
rm(data_summarised_1, data_summarised_2)
```

## Calculate performance measures 
```{r}
data1 <- data %>%
  mutate(n = paste0(("n = "), n)) %>% 
  
  # Performance measures
  mutate(hit_flag = ifelse(lb <= true_beta & ub >= true_beta,
                           T, #90% interval contains true_beta
                           F)) %>%
  
  mutate(hit_flag_be = ifelse(lb <= mean_beta & ub >= mean_beta,
                              T, #90% interval contains true_beta
                              F)) %>%
  
  mutate(bias = beta - true_beta) %>% 
  mutate(bias_rel = beta - mean_beta) %>%
  mutate(intwidth_rel = int_width - mean_intwidth) %>% 
  
  # Cleaning
  mutate(degen_flag = ifelse(beta == lb | beta == ub, # flag rows where beta = lb or ub
                             T, # interval is degenerate
                             F) ) %>%
  # New labels for methods
  mutate(group = ifelse(method %in% c("biid", "bnid"), 
                      "Bayesian",
                      ifelse(method %in% c("iid", "ker", "nid"), 
                             "Frequentist: Wald/ direct \ninference intervals",
                             ifelse(method %in% c("riid", "rnid"),
                                    "Frequentist: rank intervals",
                                    "Frequentist: bootstrapped intervals"))))


# force methods to be read in a particular order
data1$method <- factor(data1$method, levels = c("iid", "nid", "ker", "riid", "rnid", 
                                            "xy", "wxy", "pwy", "mcmb", "wild", "pbs", 
                                            "biid", "bnid"))
```

<!-- Testing -->
<!-- ```{r} -->
<!-- # OLD: used for testing intwidth_var -->
<!-- data_variability <- data %>%  -->
<!--   mutate(n = paste0(("n = "), n)) %>%  -->
<!--   mutate(intwidth_rel = int_width - mean_intwidth) %>%  -->
<!--   filter(is.na(intwidth_rel) == F) %>%  -->
<!--   mutate(infin_flag = ifelse(is.infinite(lb) == T | is.infinite(ub) == T, # flag rows w infinite intervals -->
<!--                              T, # interval is degenerate -->
<!--                              F) ) -->



<!-- data_mcmb_notconverged <- data1 %>%  -->
<!--   filter(method == "mcmb") %>%  -->
<!--   # filter(is.na(beta) == T) %>%  -->
<!--   filter(model == "Model 3") -->
<!-- ``` -->


## make "res" (shortens "data" into something which can actually be interpretted)
```{r}
sims <- 1000 # the number of simulations that were run. Use this for bias, empSE, and MSE
# "nsims" variable will be created to determine the number of simulations which gave non-infinite intervals. 

# Calculations for these performance measures came from Morris et al. 2017!

res <- data1 %>% 
  group_by(method, n, model, tau, group, status) %>% 
  summarise(degen = sum(degen_flag == T) / sims, # proportion of degenerate intervals
            infin = sum(infin_flag == T) / sims, # proportion of infinite intervals
            na = sum(na_flag == T) / sims, # proportion of effect estimates failing to converge
            skip = (sum(infin_flag == T | na_flag == T) / sims), # proportion of skips needed
            nsims = sims - (sims*skip), # the number of simulations with no problems
            
            # effect estimate-based performance measures
            ## Note: will only use riid, biid method for this, so I do NOT need to take infinite intervals or effect estimates that failed to converge into account (as this was only a problem for the mcmb method). Thus I use "sims" and not "nsims". 
            bias = sum(bias) / sims,
            bias_se = sqrt( sum((bias_rel)^2) / (sims * (sims -1)) ),
            
            empSE = sqrt( sum((bias_rel)^2) / (sims - 1) ),
            empSE_se = empSE / sqrt( 2  * (sims - 1) ), # empSE_se depends on empSE value
            
            MSE = sum((bias)^2) / sims,
            MSE_se = sqrt( ( sum( (bias)^2 - MSE) )^2 / sims*(sims-1) ), # MSE_se depends on MSE value
            
            
            # interval-based performance measures
            cov = sum(hit_flag == T, na.rm = T) / nsims, #### Emperical coverage probability
            cov_se = sqrt( cov * (1-cov) / nsims ), # cov_se depends on cov value
            
            cov_be = sum(hit_flag_be == T, na.rm = T) / nsims, #### Bias-adjusted Emperical Coverage Prob.
            cov_be_se = sqrt( cov_be * (1-cov_be) / nsims ), # cov_be_se depends on cov_be value
            
            intwidth_sd = sd(int_width, na.rm = T),
            
            intwidth_empSE = sqrt( sum((intwidth_rel)^2, na.rm = T) / (nsims - 1) ),
            intwidth_empSE_se = intwidth_empSE / sqrt( 2  * (nsims - 1) ), 
            
            meanbeta = mean(beta)
            ) 

res <- res %>% 
  mutate(blank = F)
# res$blank <- as.factor(res$blank)

# Note: MSE, MSE_se, cov_be, cov_be_se, intwidth_sd, meanbeta are no longer used in the analysis. Left them in anyways in case I end up needing them at some point. 
```

testing
```{r}
# res_variability <- data_variability %>% 
#   group_by(method, n, model, tau, group, dithered, gold) %>% 
#   summarise(infin = sum(infin_flag == T) / sims, # frequency of infinite intervals
#            nsims = sims - (sims*infin), # the number of simulations with non-infinite intervals
#             
#            intwidth_empSE = sqrt( sum((intwidth_rel)^2, na.rm = T) / (nsims - 1) ),
#            intwidth_empSE_se = intwidth_empSE / sqrt( 2  * (nsims - 1) )
#            )

testing_res_na <- res %>% 
  filter(na != 0)

testing_res_infin <- res %>% 
  filter(infin != 0)

testing_res_degen <- res %>% 
  filter(degen != 0)

testing_res_skip <- res %>% 
  filter(skip != 0)
```


## filter "res"
```{r}
# get rid of unncesssary methods
res <- res %>% 
  filter(method %in% c("nid", "riid", "rnid", "xy", "wild", "pbs", "biid", "bnid")) %>% 
  mutate(method = factor(method, c("biid", "bnid", "pbs", "wild", "xy", "riid", "rnid", "nid"))) # change order

# add superscripts
res$method <- res$method %>% 
  mapvalues("riid", "riidᵃ") %>% 
  mapvalues("rnid", "rnidᵃ")
```


```{r}
# dataset for bias and empSE
## all 11 frequentist methods give the same beta estimate.
## both Bayesian methods give the same beta estimate
res_short <- res %>%
  filter(method %in% c("xy", "biid")) %>%
  mutate(group_reformat = ifelse(group != "Bayesian", # Change the lables for the "group" variable
                           "Frequentist
(pbs, wild,
xy, riid, 
rnid, nid)",
                           "Bayesian
(biid, bnid)"))


# datasets for empirical coverage prob and CI width_var

res_count <- res %>% ## Uses all 13 methods, Only count data is simulated
  filter(status != "Freq. (cnts)")

res_cnts <- res %>% ## Uses all 11 Frequentist methods (Bayesian methods ommitted), only countinuous data is simulated
  filter(status == "Freq. (cnts)")

res_count_vs_cnts <- res %>% # For comparing dith. FQR on count data vs undithered FQR on continuous data
  filter(status != "Bayesian")

```


## colours
```{r}
show_col(hue_pal()(4))
col_3 <- c("#7CAE00", "#00BFC4", "#C77CFF")
```


# Manuscript figures

# labels
```{r}
y_cov <- "Empirical covarage probabilities (+/- 1 Monte Carlo standard error)"
y_intwidthvar <- "Empirical standard deviation of 90% interval widths (+/- 1 Monte Carlo standard error)"
y_bias <- "Bias (+/- 1 Monte Carlo standard error)"
y_empSE <- "Empirical standard error of point estimates (+/- 1 Monte Carlo standard error)"

col_title <- "QR method family"

fig_width <- 7.5
```


## cov

### Dith, count data
```{r}
cov_limit <- 0.5
res_count$blank <- F
facet_margin <- 0.05

fig_height <- 8
```


#### main fig
```{r}
data_tmp <- res_count %>% 
  filter(n == "n = 250") %>% 
  # if coverage rate is out of bounds (below 50%), then it should be replaced with an arrow
  mutate(alpha = ifelse(cov < cov_limit, 1, 0)) %>% 
  mutate(cov_se = ifelse(cov < cov_limit, 0, cov_se)) %>%
  mutate(cov = ifelse(cov < cov_limit, 0, cov)) 
  

fig_cov_250 <- gg_geom_point(.data = data_tmp, x =tau, y = cov, ymin = cov - cov_se, ymax = cov + cov_se,
                shape = blank, shape_vec = c(1), shape_title = NULL,
                colour = group, col_title = col_title, 
                legend.direction = "horizontal",
                facet_type = "grid", hori = "model", vert = "method",  p_dodge = F,
                ylab = y_cov, xlab = "Quantile",
                # title = "A) n = 250", text_size_title = 10,
                text_size_minor = 7, text_size_major = 9, yint = 0.9, 
                limits = c(cov_limit,1), coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.15, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.1) ) +
  geom_segment(data = data_tmp, 
               aes(y = 0.7, yend = 0.5, 
                   x = tau, xend = tau, alpha = alpha),
               arrow = arrow(length = unit(0.05, "inch"))) +
  scale_alpha(range = c(0,1)) + 
  facet_grid(method ~ model) + 
  guides(alpha = "none") 

  
ggsave(file = paste0("sim study/results/fig_cov_250", "_",  Sys.Date(), ".png"), width = fig_width, height = fig_height, dpi = 300)

```


#### supp
```{r}
data_tmp <- res_count %>% 
  filter(n == "n = 100") %>% 
  mutate(alpha = ifelse(cov < cov_limit, 1, 0)) %>% 
  mutate(cov_se = ifelse(cov < cov_limit, 0, cov_se)) %>%
  mutate(cov = ifelse(cov < cov_limit, 0, cov)) 

fig_cov_100 <- data_tmp %>% 
  gg_geom_point(x =tau, y = cov, ymin = cov - cov_se, ymax = cov + cov_se,
                shape = blank, shape_vec = c(1), shape_title = NULL,
                colour = group, col_title = col_title, 
                legend.direction = "horizontal",
                facet_type = "grid", hori = "model", vert = "method",  p_dodge = F,
                ylab = y_cov, xlab = "Quantile",
                title = "A) n = 100", text_size_title = 10,
                text_size_minor = 7, text_size_major = 9, yint = 0.9, 
                limits = c(cov_limit,1), coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.15, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.1) ) +
  geom_segment(data = data_tmp, 
               aes(y = 0.7, yend = 0.5, 
                   x = tau, xend = tau, alpha = alpha),
               arrow = arrow(length = unit(0.05, "inch"))) +
  scale_alpha(range = c(0,1)) + 
  facet_grid(method ~ model) + 
  guides(alpha = "none") 

ggsave(file = paste0("sim study/results/fig_cov_supp_100", "_",  Sys.Date(), ".png"), width = fig_width, height = fig_height, dpi = 300)

# data_tmp <- res_count %>% 
#   filter(n == "n = 250") %>%
#   mutate(alpha = ifelse(cov < cov_limit, 1, 0)) %>% 
#   mutate(cov_se = ifelse(cov < cov_limit, 0, cov_se)) %>%
#   mutate(cov = ifelse(cov < cov_limit, 0, cov)) 
# 
# fig_cov_250 <- data_tmp %>% 
#   gg_geom_point(x =tau, y = cov, ymin = cov - cov_se, ymax = cov + cov_se,
#                 shape = blank, shape_vec = c(1), shape_title = NULL,
#                 colour = group, col_title = col_title, 
#                 legend.direction = "horizontal",
#                 facet_type = "grid", hori = "model", vert = "method",  p_dodge = F,
#                 ylab = y_cov, xlab = "Quantile",
#                 title = "B) n = 250", text_size_title = 10,
#                 text_size_minor = 7, text_size_major = 9, yint = 0.9, 
#                 limits = c(cov_limit,1), coord_flip = T, ystrip_angle = 0,
#                 panel.spacing.x = 0.15, panel.spacing.y = 0.05) + 
#   scale_y_continuous(labels = scales::number_format(accuracy = 0.1) ) +
#   geom_segment(data = data_tmp, 
#                aes(y = 0.7, yend = 0.5, 
#                    x = tau, xend = tau, alpha = alpha),
#                arrow = arrow(length = unit(0.05, "inch"))) +
#   scale_alpha(range = c(0,1)) + 
#   facet_grid(method ~ model) + 
#   guides(alpha = "none") 
# 
# 
# ggsave(file = paste0("sim study/results/fig_cov_supp_250", "_",  Sys.Date(), ".png"), width = fig_width, height = fig_height, dpi = 300)

data_tmp <- res_count %>% 
  filter(n == "n = 500") %>% 
  mutate(alpha = ifelse(cov < cov_limit, 1, 0)) %>% 
  mutate(cov_se = ifelse(cov < cov_limit, 0, cov_se)) %>%
  mutate(cov = ifelse(cov < cov_limit, 0, cov)) 

fig_cov_500 <- data_tmp %>% 
  gg_geom_point(x =tau, y = cov, ymin = cov - cov_se, ymax = cov + cov_se,
                shape = blank, shape_vec = c(1), shape_title = NULL,
                colour = group, col_title = col_title, 
                legend.direction = "horizontal",
                facet_type = "grid", hori = "model", vert = "method",  p_dodge = F,
                ylab = y_cov, xlab = "Quantile",
                title = "B) n = 500", text_size_title = 10,
                text_size_minor = 7, text_size_major = 9, yint = 0.9, 
                limits = c(cov_limit,1), coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.15, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.1) ) +
  geom_segment(data = data_tmp, 
               aes(y = 0.7, yend = 0.5, 
                   x = tau, xend = tau, alpha = alpha),
               arrow = arrow(length = unit(0.05, "inch"))) +
  scale_alpha(range = c(0,1)) + 
  facet_grid(method ~ model) + 
  guides(alpha = "none") 

ggsave(file = paste0("sim study/results/fig_cov_supp_500", "_",  Sys.Date(), ".png"), width = fig_width, height = fig_height, dpi = 300)
```

### count vs cnts
```{r}
data_tmp <- res_count_vs_cnts %>% 
  filter(tau %in% c(0.1, 0.5, 0.9)) %>% 
  mutate(status_reformat = ifelse(status == "Freq. (count)",
                           "Count data, dithered",
                           "Continuous data, not dithered"))

limits <- c(0.7, 1)
fig_height <- 7
```


```{r}
fig_cov_cntsvscount_100 <- data_tmp %>% 
  filter(n == "n = 100") %>% 
  gg_geom_point(x = tau, y = cov, ymin = cov - cov_se, ymax = cov + cov_se,
                shape = status_reformat, shape_vec = c(0, 1), shape_title = "Status",
                colour = group, col_title = col_title, colour_vec = col_3,
                legend.direction = "horizontal",
                facet_type = "grid", hori = "model", vert = "method",  p_dodge = T,
                ylab = y_cov, xlab = "Quantile",
                title = "A) n = 100", text_size_title = 10,
                text_size_minor = 7, text_size_major = 9, yint = 0.9, 
                limits = limits, coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.15, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.1) )
  
ggsave(file = paste0("sim study/results/fig_cov_countvscnts_100", "_",  Sys.Date(), ".png"), width = fig_width, height = fig_height, dpi = 300)

fig_cov_cntsvscount_250 <- data_tmp %>% 
  filter(n == "n = 250") %>% 
  gg_geom_point(x = tau, y = cov, ymin = cov - cov_se, ymax = cov + cov_se,
                shape = status_reformat, shape_vec = c(0, 1), shape_title = "Status",
                colour = group, col_title = col_title, colour_vec = col_3,
                legend.direction = "horizontal",
                facet_type = "grid", hori = "model", vert = "method",  p_dodge = T,
                ylab = y_cov, xlab = "Quantile",
                title = "B) n = 250", text_size_title = 10,
                text_size_minor = 7, text_size_major = 9, yint = 0.9, 
                limits = limits, coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.15, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.1) )

ggsave(file = paste0("sim study/results/fig_cov_countvscnts_250", "_",  Sys.Date(), ".png"), width = fig_width, height = fig_height, dpi = 300)

fig_cov_cntsvscount_500 <- data_tmp %>% 
  filter(n == "n = 500") %>% 
  gg_geom_point(x = tau, y = cov, ymin = cov - cov_se, ymax = cov + cov_se,
                shape = status_reformat, shape_vec = c(0, 1), shape_title = "Status",
                colour = group, col_title = col_title, colour_vec = col_3,
                legend.direction = "horizontal",
                facet_type = "grid", hori = "model", vert = "method",  p_dodge = T,
                ylab = y_cov, xlab = "Quantile",
                title = "C) n = 500", text_size_title = 10,
                text_size_minor = 7, text_size_major = 9, yint = 0.9, 
                limits = limits, coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.15, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.1) )

ggsave(file = paste0("sim study/results/fig_cov_countvscnts_500", "_",  Sys.Date(), ".png"), width = fig_width, height = fig_height, dpi = 300)
```


<!-- ```{r} -->
<!-- fig_cov_cntsvscount_mod4 <- res_count_vs_cnts %>%  -->
<!--   filter(model == "Model 4") %>%  -->
<!--   filter(tau %in% c(0.1, 0.5, 0.9)) %>%  -->
<!--   mutate(status_reformat = ifelse(status == "Freq. (count)", -->
<!--                            "Count data, dithered", -->
<!--                            "Continuous data, not dithered")) %>%  -->
<!--   gg_geom_point(x = tau, y = cov, ymin = cov - cov_se, ymax = cov + cov_se, -->
<!--                 shape = status_reformat, shape_vec = c(0, 1), shape_title = "Status", -->
<!--                 colour = group, col_title = col_title, colour_vec = col_3, -->
<!--                 legend.direction = "horizontal", -->
<!--                 facet_type = "grid", hori = "n", vert = "method",  p_dodge = T, -->
<!--                 ylab = y_cov, -->
<!--                 xlab = "Quantile", -->
<!--                 title = "Model 4", text_size_title = 10, -->
<!--                 text_size_minor = 7, text_size_major = 9, yint = 0.9,  -->
<!--                 limits = c(0.7,1), coord_flip = T, ystrip_angle = 0, -->
<!--                 panel.spacing.x = 0.15, panel.spacing.y = 0.05) +  -->
<!--   scale_y_continuous(labels = number_format(accuracy = 0.1) ) -->

<!-- ggsave(file = paste0("sim study/results/fig_cov_countvscnts_mod4", "_",  Sys.Date(), ".png"), width = fig_width, height = fig_height, dpi = 300) -->

<!-- ``` -->


## intwidth var

### tau=0.9 only, dith only

#### main
```{r}
fig_intwidthvar_250 <- res_count %>% 
  filter(tau == 0.9) %>% 
  filter(n == "n = 250") %>%
  gg_geom_point(x = method, y = intwidth_empSE, 
                ymin = intwidth_empSE - intwidth_empSE_se, 
                ymax = intwidth_empSE + intwidth_empSE_se,
                shape = blank, shape_vec = c(1), shape_title = NULL,
                colour = group, col_title = col_title, 
                legend.direction = "horizontal",
                facet_type = "grid", hori = "model", p_dodge = F, scales = "free",
                ylab = y_intwidthvar,
                xlab = "Quantile regression method",
                text_size_minor = 7, text_size_major = 9,
                yint = NULL, coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.1, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = number_format(accuracy = 0.1) ) 

ggsave(file = paste0("sim study/results/fig_intwidthvar_250_main", "_",  Sys.Date(), ".png"),
       width = fig_width, height = 3.5, dpi = 300)

```

#### supp
```{r}
fig_intwidthvar_100 <- res_count %>% 
  filter(tau == 0.9) %>% 
  filter(n == "n = 100") %>%
  gg_geom_point(x = method, y = intwidth_empSE, 
                ymin = intwidth_empSE - intwidth_empSE_se, 
                ymax = intwidth_empSE + intwidth_empSE_se,
                shape = blank, shape_vec = c(1), shape_title = NULL,
                colour = group, col_title = col_title, 
                legend.direction = "horizontal",
                facet_type = "grid", hori = "model", p_dodge = F, scales = "free",
                ylab = y_intwidthvar,
                xlab = "Quantile regression method",
                title = "A) n = 100", text_size_title = 10,
                text_size_minor = 7, text_size_major = 9,
                yint = NULL, coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.1, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = number_format(accuracy = 0.1) ) 

# fig_intwidthvar_250 <- res_count %>% 
#   filter(tau == 0.9) %>% 
#   filter(n == "n = 250") %>%
#   gg_geom_point(x = method, y = intwidth_empSE, 
#                 ymin = intwidth_empSE - intwidth_empSE_se, 
#                 ymax = intwidth_empSE + intwidth_empSE_se,
#                 shape = blank, shape_vec = c(1), shape_title = NULL,
#                 colour = group, col_title = col_title, 
#                 legend.direction = "horizontal",
#                 facet_type = "grid", hori = "model", p_dodge = F, scales = "free",
#                 ylab = y_intwidthvar,
#                 xlab = "Quantile regression method",
#                 title = "B) n = 250", text_size_title = 10,
#                 text_size_minor = 7, text_size_major = 9,
#                 yint = NULL, coord_flip = T, ystrip_angle = 0,
#                 panel.spacing.x = 0.1, panel.spacing.y = 0.05) + 
#   scale_y_continuous(labels = number_format(accuracy = 0.1) ) 

fig_intwidthvar_500 <- res_count %>% 
  filter(tau == 0.9) %>% 
  filter(n == "n = 500") %>%
  gg_geom_point(x = method, y = intwidth_empSE, 
                ymin = intwidth_empSE - intwidth_empSE_se, 
                ymax = intwidth_empSE + intwidth_empSE_se,
                shape = blank, shape_vec = c(1), shape_title = NULL,
                colour = group, col_title = col_title, 
                legend.direction = "horizontal",
                facet_type = "grid", hori = "model", p_dodge = F, scales = "free",
                ylab = y_intwidthvar,
                xlab = "Quantile regression method",
                title = "B) n = 500", text_size_title = 10,
                text_size_minor = 7, text_size_major = 9,
                yint = NULL, coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.1, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = number_format(accuracy = 0.1) ) 

fig_intwidthvar_all <- ggarrange(fig_intwidthvar_100, fig_intwidthvar_500,
                                 common.legend = T, ncol = 1, legend = "bottom")

ggsave(file = paste0("sim study/results/fig_intwidthvar_supp_all", "_",  Sys.Date(), ".png"), width = fig_width, height = 6, dpi = 300)
```


### count vs cnts
```{r}
legend.margin_inch <- 0.0000000000000000000000625
legend.spacing <- 0.00000000000000000000000000625


fig_intwidthvar_g_vs_c_100 <- res_count_vs_cnts %>% 
  filter(n == "n = 100") %>% 
  filter(tau == 0.9) %>% 
  mutate(status_reformat = ifelse(status == "Freq. (count)",
                           "Count data, dithered",
                           "Continuous data, not dithered")) %>%
  gg_geom_point(x = method, y = intwidth_empSE, 
                ymin = intwidth_empSE - intwidth_empSE_se, 
                ymax = intwidth_empSE + intwidth_empSE_se,
                shape = status_reformat, shape_vec = c(0, 1), shape_title = "Status",
                colour = group, col_title = col_title, colour_vec = col_3,
                legend.direction = "horizontal", 
                legend.margin_inch = legend.margin_inch, legend.spacing = legend.spacing,
                facet_type = "grid", hori = "model",  
                p_dodge = T, scales = "free",
                ylab = y_intwidthvar,
                xlab = "Quantile regression method",
                title = "A) n = 100", text_size_title = 10,
                text_size_minor = 7, text_size_major = 9,
                yint = NULL, coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.2, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = number_format(accuracy = 0.1) ) 

fig_intwidthvar_g_vs_c_250 <- res_count_vs_cnts %>% 
  filter(n == "n = 250") %>% 
  filter(tau == 0.9) %>% 
  mutate(status_reformat = ifelse(status == "Freq. (count)",
                                  "Count data, dithered",
                                  "Continuous data, not dithered")) %>%
  gg_geom_point(x = method, y = intwidth_empSE, 
                ymin = intwidth_empSE - intwidth_empSE_se, 
                ymax = intwidth_empSE + intwidth_empSE_se,
                shape = status_reformat, shape_vec = c(0, 1), shape_title = "Status",
                colour = group, col_title = col_title, colour_vec = col_3,
                legend.direction = "horizontal", 
                legend.margin_inch = legend.margin_inch, legend.spacing = legend.spacing,
                facet_type = "grid", hori = "model",  
                p_dodge = T, scales = "free",
                ylab = y_intwidthvar,
                xlab = "Quantile regression method",
                title = "B) n = 250", text_size_title = 10,
                text_size_minor = 7, text_size_major = 9,
                yint = NULL, coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.2, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = number_format(accuracy = 0.1) ) 

fig_intwidthvar_g_vs_c_500 <- res_count_vs_cnts %>% 
  filter(n == "n = 500") %>% 
  filter(tau == 0.9) %>% 
  mutate(status_reformat = ifelse(status == "Freq. (count)",
                                  "Count data, dithered",
                                  "Continuous data, not dithered")) %>%
  gg_geom_point(x = method, y = intwidth_empSE, 
                ymin = intwidth_empSE - intwidth_empSE_se, 
                ymax = intwidth_empSE + intwidth_empSE_se,
                shape = status_reformat, shape_vec = c(0, 1), shape_title = "Status",
                colour = group, col_title = col_title, colour_vec = col_3,
                legend.direction = "horizontal", 
                legend.margin_inch = legend.margin_inch, legend.spacing = legend.spacing,
                facet_type = "grid", hori = "model",  
                p_dodge = T, scales = "free",
                ylab = y_intwidthvar,
                xlab = "Quantile regression method",
                title = "C) n = 500", text_size_title = 10,
                text_size_minor = 7, text_size_major = 9,
                yint = NULL, coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.2, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = number_format(accuracy = 0.1) ) 

fig_intwidthvar_g_vs_c_all <- ggarrange(fig_intwidthvar_g_vs_c_100, fig_intwidthvar_g_vs_c_250,
                                        fig_intwidthvar_g_vs_c_500,
                                        common.legend = T, ncol = 1, legend = "bottom")

ggsave(file = paste0("sim study/results/fig_intwidthvar_countvscnts_all", "_",  Sys.Date(), ".png"), 
       width = fig_width, height = 10, dpi = 300)

```

## Special fig: count vs cnts 

```{r}
legend.margin_inch <- 0.0000000000000000000000625
legend.spacing <- 0.00000000000000000000000000625


# Bias
fig__sp_bias <- res_short %>% 
  filter(status != "Bayesian") %>%
  mutate(status_reformat = ifelse(status == "Freq. (count)",
                           "Count data, dithered",
                           "Continuous data, not dithered")) %>%
  filter(n == "n = 250") %>% 
  gg_geom_point(x = tau, y = bias, ymin = bias-bias_se, ymax = bias + bias_se,
                shape = status_reformat, shape_vec = c(0, 1), shape_title = "Status",
                # colour = group, col_title = col_title, 
                legend.direction = "horizontal",
                facet_type = "grid", hori = "model", vert = "group_reformat", 
                p_dodge = T, scales = "free_x",
                ylab = y_bias, 
                xlab = "Quantile",
                title = "A) Bias", text_size_title = 10,
                text_size_minor = 7, text_size_major = 9,
                coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.2, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = number_format(accuracy = 0.01) )

# Variability of effect estimates
fig_sp_empSE <- res_short %>% 
  filter(status != "Bayesian") %>% 
  mutate(status_reformat = ifelse(status == "Freq. (count)",
                           "Count data, dithered",
                           "Continuous data, not dithered")) %>%
  filter(n == "n = 250") %>% 
  gg_geom_point(x = tau, y = empSE, ymin = empSE-empSE_se, ymax = empSE + empSE_se,
                shape = status_reformat, shape_vec = c(0, 1), shape_title = "Status",
                # colour = group, col_title = col_title, 
                legend.direction = "horizontal",
                facet_type = "grid", hori = "model", vert = "group_reformat", 
                p_dodge = T, scales = "free_x",
                ylab = y_empSE, 
                xlab = "Quantile",
                title = "B) Variability of point estimates",
                text_size_title = 10,
                text_size_minor = 7, text_size_major = 9,
                yint = NULL, coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.2, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = number_format(accuracy = 0.01) )


fig_sp_cov <- res_count_vs_cnts %>% 
  filter(n == "n = 250") %>% 
  filter(method == "xy") %>% 
  mutate(status_reformat = ifelse(status == "Freq. (count)",
                           "Count data, dithered",
                           "Continuous data, not dithered")) %>% 
  gg_geom_point(x = tau, y = cov, ymin = cov - cov_se, ymax = cov + cov_se,
                shape = status_reformat, shape_vec = c(0, 1), shape_title = "Status",
                colour = group, col_title = col_title, 
                colour_vec = col_3,
                legend.direction = "horizontal",
                facet_type = "grid", hori = "model", vert = "method",  p_dodge = T,
                ylab = y_cov, 
                xlab = "Quantile",
                title = "C) Empirical coverage probabilities", text_size_title = 10,
                text_size_minor = 7, text_size_major = 9, yint = 0.9, 
                limits = c(0.8,1), coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.2, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.05) )

fig_sp_intwidthvar <- res_count_vs_cnts %>% 
  filter(n == "n = 250") %>% 
  # filter(tau == 0.9) %>% 
  filter(method == "xy") %>% 
  mutate(status_reformat = ifelse(status == "Freq. (count)",
                           "Count data, dithered",
                           "Continuous data, not dithered")) %>% 
  gg_geom_point(x = tau, y = intwidth_empSE, ymin = intwidth_empSE - intwidth_empSE_se, 
                ymax = intwidth_empSE + intwidth_empSE_se,
                shape = status_reformat, shape_vec = c(0, 1), shape_title = "Status",
                colour = group, col_title = col_title, colour_vec = col_3,
                legend.direction = "horizontal", 
                legend.margin_inch = legend.margin_inch, legend.spacing = legend.spacing,
                facet_type = "grid", hori = "model",  vert = "method",
                p_dodge = T, scales = "free_x",
                ylab = y_intwidthvar,
                xlab = "Quantile",
                title = "D) Variability of interval widths", text_size_title = 10,
                text_size_minor = 7, text_size_major = 9,
                yint = NULL, coord_flip = T, ystrip_angle = 0,
                panel.spacing.x = 0.2, panel.spacing.y = 0.05) + 
  scale_y_continuous(labels = number_format(accuracy = 0.05) )

fig_sp_countvscnts <- ggarrange(fig__sp_bias, fig_sp_empSE, 
                     fig_sp_cov, fig_sp_intwidthvar,
                     common.legend = T, ncol = 1, legend = "bottom")

ggsave(file = paste0("sim study/results/fig_sp_countvscnts", "_",  Sys.Date(), ".png"), 
       width = fig_width, height = 9, dpi = 300)

ggsave(file = paste0("sim study/results/fig_sp_countvscnts", "_",  Sys.Date(), ".pdf"), 
       width = fig_width, height = 9, dpi = 300)

ggsave(file = paste0("sim study/results/fig_sp_countvscnts", "_",  Sys.Date(), ".eps"), 
       width = fig_width, height = 9, dpi = 300)


```


```{r}

```






